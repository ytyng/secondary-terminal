# 完了したタスク

## スクロールバッファクリア時の強制スクロール問題の修正

30秒ごとに HTML のスクロールバッファのクリアをしているが、その時にスクロールが強制的に最下部に移動するのが使いづらい。

・変化が無かったら移動しない
・極力移動しない。同仕様もない時だけ(問題のある時だけ)
移動する。

というふうにしてほしい。

しかし、スクロールバッファが減るだけなら、そもそもスクロールを更新しなくてもいいのかもしれない。更新しなくていいなら更新しないようにして。よく考えて判断して。

**修正内容:**
1. フロントエンド（HTML）：バッファクリア実行前にスクロール位置を確認し、ユーザーが最下部にいない場合はスクロール位置を保持
2. バックエンド（TypeScript）：スクロール位置保持の要求を処理し、必要に応じてバッファクリアをスキップ

---

# タスク

長い文章をペーストすると、途中で入力が途切れてしまう。
コードをよく見て原因を調べ、ペーストした内容がすべて入力されるよう修正してください。

---

アプリの起動確認の際、今は claude や gemini の起動を確認しています。「codex」の起動が確認できたら、codex モードにしてください。

codex モードでは、 Shift + Enter が入力された時、 Control + J をエミュレーションしてください。

---

# ターミナルスクロール性能問題の修正

しばらく使っていると、ターミナルのスクロールがどんどん遅くなる。理由はなんだろう?最初はサクサク動くが、徐々にスクロールが遅くなる。

スクロールバッファが遅いのが問題かと思って、300行をリミットにしてみたけど、変わらず遅くなる問題が出続ける。

問題は何だと思う? 問題になりそうな所にあたりをつけて、ログを出すとかして調査したい。コードをよく読んで、問題を特定して。

おそらく描画側で、なにかを描画するたびにリソースが溜まっていって遅くなっているんだと思う。

しかし、表示上みつけることはできない。スクロールバックも300秒なので問題は無いと思う。

補足:
右下のボタンで Reset をすると解消される。

clear コマンドでは解消しない。

**修正内容:**
1. Canvas Background Color 処理の最適化（四隅チェック→単一ピクセル、安定後は頻度低下）
2. 定期サイズチェック処理の最適化（変更なし時の頻度低下）
3. 出力処理の詳細統計ログ追加
4. xterm.js のパフォーマンス設定追加
5. エラー時の自動リソース解放処理を追加

---

# Claude Code ペースト問題の修正

claude code を起動し、大量の文字をペーストすると固まってしまう。vim とかだと問題なくペーストされる。

あと、iTerm を別で起動し、そこで claude code を起動してペーストするとちゃんと貼り付けできる。

このアプリのターミナルで、claude code の場合だけだめだ。

良い対応方法があるか、chat gpt にも聞きながら調べて。

もし無理なら、claude code モードの時は、大量の文字列のペーストが発生した時、チャンクに分けてゆっくりペーストするとかできないか？

最悪、ゆっくりペーストが発生したのをフックするのが無理なら、UIの下部にペーストボタンを作ってもいい

**修正内容:**
1. フロントエンド改修：xterm.js に bracketedPasteMode を有効化、DOM の paste イベントハンドラーを追加
2. チャンク送信機能：32KB チャンクで base64 エンコーディング、ACK 待ち制御を実装
3. 拡張機能改修：terminalInputBegin/Chunk/End メッセージタイプを追加
4. バックプレッシャー制御：child.stdin.write の戻り値チェックと drain イベント待ちを実装
5. ShellProcessManager に sendToProcessWithBackpressure と waitForDrain メソッドを追加

**バグ修正:**
- xterm.js v5.5.0 では onPaste メソッドが利用できないため、DOM の paste イベントを使用する方法に変更

---

# ACE エディタ統合

ターミナルウインドウのペインと下部コントロールの間に、コード入力用のテキストエリアを設置してほしい。

[@/Users/yotsuyanagi/workspace/secondary-terminal/resources/terminal.html (L:185-186)]
```
<!-- ここにテキストエリアペインを作成 -->
        <!-- 単純なテキストエリアではなく ACE エディタを組み込む -->
```

ここに入れて。

ACE エディタを使って、height = 300 程度のテキストエリアを作る。

ACE エディタの書き方は、
/Users/yotsuyanagi/workspace/vscode-side-editor
を参考にして。

エディタで、 Command + Enter を入力したら、その文字をターミナルに入力するようにして。

また、最下部の @section copy のボタンは、押下時はテキストを ACEエディタに入力するようにして。

入力内容は、extension が非アクティブになり、ふたたびアクティブになった時、入力内容を復旧するようにして。

**完了済み (2025-09-24)**

**実装内容:**
1. ACE エディタを terminal.html に統合 (height: 300px)
2. Command+Enter でエディタ内容をターミナル送信機能を実装
3. Copy ボタンでテキストを ACE エディタに入力する機能を実装
4. 拡張機能の非アクティブ/アクティブ時の状態復旧機能を実装
5. VSCode テーマに合わせたスタイリング適用
6. ace-builds 依存関係をパッケージに追加
7. terminalProvider.ts で ACE エディタ関連メッセージハンドリングを追加

---

# パフォーマンス計測 HUD の実装

長時間使用時のスクロール遅延の原因を特定するため、リアルタイムパフォーマンス計測 HUD を実装。

**完了済み (2025-10-02)**

**実装内容:**
1. パフォーマンス計測オブジェクト (performanceMetrics) を追加
   - メモリ関連: writeBufferSize, scrollbackLines, terminalBufferSize
   - 処理時間関連: lastWriteTime, avgWriteTime, maxWriteTime
   - カウンター: outputCount, totalOutputChars, resizeObserverCount
   - セッション時間: sessionStartTime, lastUpdateTime

2. 計測ポイントの実装
   - term.write() 実行時間の測定と平均/最大値の記録
   - output メッセージ受信時のカウント更新
   - ResizeObserver 実行回数の記録
   - xterm.js scrollback buffer サイズの取得

3. HUD UI の実装
   - 右上に position: fixed で半透明オーバーレイを配置
   - 緑色のサイバーな見た目で計測データを表示
   - 500ms ごとにポーリングで自動更新
   - 表示項目: Buffer サイズ, Scrollback 行数, Write 平均/最大時間, Output メッセージ数, 総文字数, Resize 回数, セッション時間

4. 表示切り替え機能
   - 右上に 📊 ボタンを配置
   - クリックで HUD の表示/非表示を切り替え
   - localStorage で状態を永続化

**期待効果:**
- 遅延発生時にどの値が増加しているかをリアルタイムで可視化
- Reset 前後の数値比較で効果測定が可能
- 問題箇所の特定が容易になる
